<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>Windows Commands</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>Windows Commands</h1><br/><p>------------------------------------------------------------</p><p>Windows Commands for Email Attachment Analysis</p><p>------------------------------------------------------------</p><p>Goal: Quickly triage suspicious attachments on a Windows analysis VM using **built-in** tools (PowerShell + a few classic Windows utilities). Each section explains: purpose → key commands → syntax → sample outputs.</p><p></p><p>Tip: Open **PowerShell** as a non-admin first; elevate only when needed. Keep originals read-only and work on copies.</p><p></p><p>------------------------------------------------------------<ol><li>Compute &amp; Export Hashes (MD5/SHA1/SHA256)</li></ol></p><p>------------------------------------------------------------</p><p>WHY: Hashes let you pivot in VirusTotal/Talos and deduplicate samples.</p><p><ul><li>Single file (SHA-256 default in PS 5+)</li></ul></p><p>  - Command:</p><p>    Get-FileHash -Path .\invoice.pdf -Algorithm SHA256</p><p>  - Parts:</p><p>    - `Get-FileHash` = computes cryptographic hash</p><p>    - `-Algorithm` = SHA256 | SHA1 | MD5</p><p>  - Sample output:</p><p>    Algorithm : SHA256</p><p>    Hash      : 6F0E7A8B...B1C7</p><p>    Path      : C:\Analysis\invoice.pdf</p><p><ul><li>Many files → CSV</li></ul></p><p>  - Command:</p><p>    Get-ChildItem -File -Recurse | Get-FileHash -Algorithm SHA256 |</p><p>      Select-Object Algorithm,Hash,Path | Export-Csv hashes.csv -NoTypeInformation</p><p><ul><li>Classic certutil (useful on older hosts)</li></ul></p><p>  - Command:</p><p>    certutil -hashfile invoice.pdf SHA256</p><p>  - Sample tail:</p><p>    SHA256 hash of invoice.pdf:</p><p>    6f 0e 7a 8b ... b1 c7</p><p>    CertUtil: -hashfile command completed successfully.</p><p></p><p>------------------------------------------------------------<ol><li>Check File Type by Magic Bytes (vs. Extension)</li></ol></p><p>------------------------------------------------------------</p><p>WHY: Attackers often disguise `.exe` as `.pdf` (e.g., `report.pdf.exe`).</p><p><ul><li>Quick hex header</li></ul></p><p>  - Command:</p><p>    Format-Hex -Path .\suspicious.bin -Count 64</p><p>  - Look for:</p><p>    - PDF: bytes start `%PDF`</p><p>    - ZIP/OOXML (docx/xlsx/pptx/jar): `50 4B 03 04` (PK..)</p><p>    - PE (Windows EXE/DLL): `4D 5A` (MZ)</p><p><ul><li>Minimal peek without full hex</li></ul></p><p>  - Command:</p><p>    Get-Content -Path .\file -Encoding Byte -TotalCount 8</p><p></p><p>------------------------------------------------------------<ol><li>Mark-of-the-Web (MOTW) / Zone.Identifier Stream</li></ol></p><p>------------------------------------------------------------</p><p>WHY: Files downloaded from the internet carry MOTW; useful provenance clue. Also gates macro behavior.</p><p><ul><li>List alternate data streams (ADS)</li></ul></p><p>  - Command:</p><p>    Get-Item -Path .\invoice.docm -Stream *</p><p>  - Sample output:</p><p>    Stream         Length</p><p>    ------         ------</p><p>    :$DATA         98304</p><p>    Zone.Identifier   160</p><p><ul><li>Read MOTW details (URL &amp; Referrer)</li></ul></p><p>  - Command:</p><p>    Get-Content -Path .\invoice.docm -Stream Zone.Identifier</p><p>  - Sample output:</p><p>    [ZoneTransfer]</p><p>    ZoneId=3</p><p>    ReferrerUrl=<a href="https://example.com">https://example.com</a></p><p>    HostUrl=<a href="https://cdn.example.com/invoice.docm">https://cdn.example.com/invoice.docm</a></p><p><ul><li>(If policy requires testing without MOTW) — don’t do on originals</li></ul></p><p>  - Command:</p><p>    Unblock-File .\invoice.docm</p><p></p><p>------------------------------------------------------------<ol><li>Inspect Office Documents (OOXML) &amp; Look for Macros</li></ol></p><p>------------------------------------------------------------</p><p>WHY: “MalDocs” often use VBA macros (`.docm`, `.xlsm`) or embed objects.</p><p><ul><li>Quick tell: “M” extension implies macros</li></ul></p><p>  - `.docm`, `.xlsm`, `.pptm` likely contain `vbaProject.bin`</p><p><ul><li>List inside Office zip containers (no 3rd-party tools)</li></ul></p><p>  - Command:</p><p>    tar -tf .\invoice.docx</p><p>  - Look for paths like:</p><p>    word/vbaProject.bin            ← Macro storage (if present)</p><p>    word/_rels/document.xml.rels   ← Embedded/external links</p><p>    word/embeddings/               ← Embedded OLE objects</p><p><ul><li>Fully extract for inspection (to a temp dir)</li></ul></p><p>  - Command:</p><p>    Expand-Archive .\invoice.docx -DestinationPath .\docx_unpacked -Force</p><p><ul><li>Hunt for URLs inside extracted XML</li></ul></p><p>  - Command (PowerShell regex):</p><p>    Select-String -Path .\docx_unpacked\**\*.xml -Pattern &#39;(?i)\bhttps?://[^\s&quot;&lt;]+&#39; -AllMatches</p><p><ul><li>Basic macro presence indicator (without parsing VBA):</li></ul></p><p>  - If `vbaProject.bin` exists → likely macros; escalate to dedicated macro tooling in your lab.</p><p></p><p>------------------------------------------------------------<ol><li>Quick PDF Triage</li></ol></p><p>------------------------------------------------------------</p><p>WHY: PDFs may carry JavaScript, launch actions, or external links.</p><p><ul><li>Confirm it’s a PDF by header</li></ul></p><p>  - Command:</p><p>    Get-Content .\invoice.pdf -TotalCount 1</p><p>  - Expect `%PDF-1.x`</p><p><ul><li>Grep for suspicious PDF markers (very rough but quick):</li></ul></p><p>  - Commands:</p><p>    Select-String .\invoice.pdf -Pattern &#39;/JS&#39;,&#39;/JavaScript&#39;,&#39;/AA&#39;,&#39;/OpenAction&#39;,&#39;/Launch&#39;</p><p>    Select-String .\invoice.pdf -Pattern &#39;(?i)\bhttps?://[^\s&lt;)&quot;]+&#39; </p><p><ul><li>Hex view for deeper spot checks</li></ul></p><p>  - Command:</p><p>    Format-Hex .\invoice.pdf -Count 256</p><p></p><p>------------------------------------------------------------<ol><li>Strings &amp; IOC Mining (Built-In Approaches)</li></ol></p><p>------------------------------------------------------------</p><p>WHY: Extract quick IOCs (URLs, emails, IPs) without third-party tools.</p><p><ul><li>URLs (HTTP/HTTPS)</li></ul></p><p>  - Command:</p><p>    Select-String -Path .\sample.bin -Pattern &#39;(?i)\bhttps?://[^\s&quot;&lt;&gt;]+&#39; -AllMatches |</p><p>      ForEach-Object { $_.Matches.Value } | Sort-Object -Unique</p><p><ul><li>Domains (basic)</li></ul></p><p>  - Command:</p><p>    Select-String .\sample.bin -Pattern &#39;(?i)\b[a-z0-9.-]+\.(com|net|org|io|co|gov|edu)\b&#39; -AllMatches |</p><p>      % { $_.Matches.Value } | Sort -Unique</p><p><ul><li>IPv4s (simple regex)</li></ul></p><p>  - Command:</p><p>    Select-String .\sample.bin -Pattern &#39;\b(?:\d{1,3}\.){3}\d{1,3}\b&#39; -AllMatches |</p><p>      % { $_.Matches.Value } | Sort -Unique</p><p><ul><li>Emails</li></ul></p><p>  - Command:</p><p>    Select-String .\sample.bin -Pattern &#39;(?i)\b[A-Z0-9._%+-]+@[A-Z0-9.-]+\.[A-Z]{2,}\b&#39; -AllMatches |</p><p>      % { $_.Matches.Value } | Sort -Unique</p><p><ul><li>Save to CSV for ticketing/SIEM</li></ul></p><p>  - Example (URLs):</p><p>    $urls = Select-String -Path .\sample.bin -Pattern &#39;(?i)\bhttps?://[^\s&quot;&lt;&gt;]+&#39; -AllMatches |</p><p>      % { $_.Matches.Value } | Sort -Unique</p><p>    $urls | ForEach-Object { [pscustomobject]@{Type=&#39;URL&#39;; Value=$_} } |</p><p>      Export-Csv .\IOCs.csv -NoTypeInformation -Append</p><p></p><p>------------------------------------------------------------<ol><li>Authenticode Signature (Executables &amp; Scripts)</li></ol></p><p>------------------------------------------------------------</p><p>WHY: Signed files aren’t always safe, but signature info helps context/attribution.</p><p><ul><li>Check signature &amp; signer</li></ul></p><p>  - Command:</p><p>    Get-AuthenticodeSignature .\setup.exe | Format-List *</p><p><ul><li>Filter for Unsigned or Unknown</li></ul></p><p>  - Command:</p><p>    Get-ChildItem -Recurse -Include *.exe,*.dll |</p><p>      Where-Object { (Get-AuthenticodeSignature $_).Status -ne &#39;Valid&#39; } |</p><p>      Select FullName, @{n=&#39;SigStatus&#39;;e={(Get-AuthenticodeSignature $_).Status}}</p><p></p><p>------------------------------------------------------------<ol><li>Base64 / Hex Decode Bits (Common in Scripted Droppers)</li></ol></p><p>------------------------------------------------------------</p><p>WHY: Malicious scripts often hide payloads/URLs in Base64.</p><p><ul><li>Base64 → file</li></ul></p><p>  - Command:</p><p>    certutil -decode payload.b64 payload.bin</p><p>  - Note: `certutil` echoes lines; verify size/hash after decode.</p><p><ul><li>Quick Base64 to string (PowerShell)</li></ul></p><p>  - Command:</p><p>    [Text.Encoding]::UTF8.GetString([Convert]::FromBase64String((Get-Content .\blob.b64 -Raw)))</p><p></p><p>------------------------------------------------------------<ol><li>Safe Preview of File Metadata (No Execution)</li></ol></p><p>------------------------------------------------------------</p><p>WHY: Learn about a file without running it.</p><p><ul><li>Basic metadata (date/size) for timeline</li></ul></p><p>  - Command:</p><p>    Get-Item .\sample | Select-Object Name,Length,LastWriteTime,CreationTime</p><p><ul><li>PE “MZ” quick check (EXE/DLL)</li></ul></p><p>  - Command:</p><p>    (Get-Content .\sample.exe -Encoding Byte -TotalCount 2) -eq 0x4D,0x5A</p><p></p><p>------------------------------------------------------------<ol><li>Archive Handling (ZIP/RAR/7z) with Built-Ins</li></ol></p><p>------------------------------------------------------------</p><p>WHY: Many malicious attachments arrive as archives.</p><p><ul><li>List ZIP contents</li></ul></p><p>  - Command:</p><p>    tar -tf .\pack.zip</p><p><ul><li>Extract ZIP safely (to a quarantined working folder)</li></ul></p><p>  - Command:</p><p>    Expand-Archive .\pack.zip -DestinationPath .\unz -Force</p><p></p><p>(For RAR/7z you’ll need external tools; document usage separately if approved.)</p><p></p><p>------------------------------------------------------------<ol><li>Quick YARA-Like Grep (Rapid Keyword Hunt)</li></ol></p><p>------------------------------------------------------------</p><p>WHY: Fast rough scan for suspicious strings before full tooling.</p><p><ul><li>Example: hunt for PowerShell download cradles</li></ul></p><p>  - Command:</p><p>    Select-String -Path .\*.ps1 -Pattern &#39;Invoke-WebRequest|IEX|FromBase64String|DownloadString&#39; -SimpleMatch</p><p><ul><li>Example: hunt for LOLBins in any text/binary (rough)</li></ul></p><p>  - Command:</p><p>    Select-String -Path .\* -Pattern &#39;rundll32|mshta|regsvr32|wscript|cscript|bitsadmin&#39; -Encoding Byte</p><p></p><p>------------------------------------------------------------<ol><li>Build a One-Shot Triage Script</li></ol></p><p>------------------------------------------------------------</p><p>WHY: Repeatable, defensible process.</p><p><ul><li>Example (save as `Triagedir.ps1`):</li></ul></p><p>  $out = @()</p><p>  Get-ChildItem -File | ForEach-Object {</p><p>    $h = Get-FileHash $_ -Algorithm SHA256</p><p>    $motw = (Get-Item $_ -Stream Zone.Identifier -ErrorAction SilentlyContinue)</p><p>    $sig = $null</p><p>    if ($_.Extension -match &#39;\.exe|\.dll&#39;) { $sig = (Get-AuthenticodeSignature $_).Status }</p><p>    $out += [pscustomobject]@{</p><p>      Name=$_.Name; Path=$_.FullName; Size=$_.Length</p><p>      SHA256=$h.Hash</p><p>      MOTW = [bool]$motw</p><p>      SigStatus = $sig</p><p>      IsPE = ((Get-Content $_ -Encoding Byte -TotalCount 2 -ErrorAction SilentlyContinue) -eq 0x4D,0x5A)</p><p>    }</p><p>  }</p><p>  $out | Export-Csv triage.csv -NoTypeInformation</p><p>  Write-Host &quot;Wrote triage.csv&quot;</p><p></p><p>Result: a CSV you can attach to the incident ticket and use to pivot (hashes to VT/Talos).</p><p></p><p>------------------------------------------------------------<ol><li>Safety Routines</li></ol></p><p>------------------------------------------------------------<ul><li>Work in a **non-indexed**, **non-synced** folder (not Desktop/OneDrive).  </li><li>Disable previews in Explorer; don’t double-click samples.  </li><li>Keep network **egress blocked** in your lab unless detonating intentionally.  </li><li>Preserve originals; only modify copies.</li></ul></p><p></p><p>------------------------------------------------------------</p><p>Memory Aid</p><p>------------------------------------------------------------</p><p>**“Hash → Header → MOTW → Unpack → Grep → Export.”**  <ul><li>Hash (Get-FileHash / certutil)  </li><li>Header (Format-Hex / magic bytes)  </li><li>MOTW (Get-Item -Stream / Get-Content -Stream)  </li><li>Unpack (Expand-Archive / tar -tf)  </li><li>Grep (Select-String regex for URLs/IPs/emails)  </li><li>Export (CSV for SIEM/ticket)</p><p></li></ul></p></div>
</body>
</html>
